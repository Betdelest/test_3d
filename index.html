<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Projet BETL</title>
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
<style>
:root{--bg:#050816;--card:#07102a;--muted:#9aa6b2;--accent:#0a84ff;--glass:rgba(255,255,255,0.06);--plan-bg: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));}
html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Arial,Helvetica,sans-serif}
header{display:flex;align-items:center;gap:12px;padding:10px 14px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);box-shadow:0 6px 18px rgba(0,0,0,0.35)}
.logo{height:72px;width:72px;object-fit:contain;border-radius:8px;cursor:pointer;flex:0 0 auto}
.titleWrap{display:flex;flex-direction:column;justify-content:center;align-items:flex-start}
.title{font-weight:800;font-size:20px;margin:0;padding:0}
.subtitle{font-size:12px;color:var(--muted);margin-top:2px}
.hdr-controls{margin-left:18px;display:flex;gap:8px;align-items:center}
select.model-select{background:transparent;border:1px solid rgba(255,255,255,0.06);border-radius:8px;padding:8px 10px;color:#fff;min-width:180px}
.container{padding:12px;display:grid;grid-template-columns:1fr 360px;gap:12px}
main.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:10px;padding:10px;min-height:60vh}
aside.card{background:var(--card);border-radius:10px;padding:12px;max-height:78vh;overflow:auto}
model-viewer{width:100%;height:58vh;border-radius:10px;background:#111;display:block}
.ar-button{position:relative;display:inline-block;margin-top:12px;padding:12px 18px;border-radius:12px;background:#fff;color:#000;border:0;font-weight:700;cursor:pointer}
.progress-wrap{display:flex;align-items:center;gap:10px;margin-top:10px;transition:opacity .25s}
.progress{flex:1;height:10px;background:#111;border-radius:999px;overflow:hidden}
.progress > span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#4bd3ff);transition:width .2s}
.progress-label{min-width:44px;text-align:right;color:var(--muted);font-size:13px}
.plan-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:rgba(255,255,255,0.02);margin-bottom:8px}
.plan-item .name{max-width:66%;font-size:14px;word-break:break-word;color:#e6eef8}
.plan-actions{display:flex;gap:8px}
.modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:1200}
.modal{width:min(1000px,96%);height:min(84vh,900px);background:#08101a;border-radius:10px;overflow:hidden;display:flex;flex-direction:column}
.modal-header{padding:10px;background:#07101a;display:flex;justify-content:space-between;align-items:center}
.modal-body{flex:1;background:#fff}
.preview-iframe{width:100%;height:100%;border:0}
.splash{position:fixed;inset:0;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2000}
.splash.hidden{opacity:0;pointer-events:none;display:none;transition:opacity .35s}
.splash-logo{width:220px;max-width:60vw;margin-bottom:8px;filter:drop-shadow(0 8px 30px rgba(0,0,0,0.6))}
.plans-docs{background:linear-gradient(180deg, rgba(4,12,24,0.75), rgba(3,10,20,0.95));color:#e6f0fb;padding:18px;border-radius:8px;margin-top:8px;border:1px solid rgba(255,255,255,0.03)}
.pd-header{display:flex;align-items:center;justify-content:space-between;gap:10px;margin-bottom:12px}
.pd-header h3{margin:0;font-size:1.03rem}
.pd-controls{display:flex;align-items:center;gap:8px}
.pd-categories{display:flex;gap:8px;flex-wrap:wrap}
.pd-category-btn{background:transparent;border:1px solid rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-size:0.82rem;color:var(--muted);cursor:pointer}
.pd-category-btn.active{background:linear-gradient(90deg,var(--accent),#4cc3ff);color:#051225;box-shadow:0 6px 22px rgba(46,166,255,0.08)}
.pd-search{background:transparent;border:1px solid rgba(255,255,255,0.04);padding:8px 12px;border-radius:10px;color:var(--muted);min-width:160px}
.pd-grid{display:grid;grid-template-columns:1fr;gap:8px}
.pd-card{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:var(--plan-bg);border:1px solid rgba(255,255,255,0.03)}
.pd-title{font-size:0.95rem}
.pd-meta{font-size:0.82rem;color:var(--muted)}
.btn{padding:8px 10px;border-radius:8px;border:0;background:var(--accent);color:#021826;cursor:pointer;font-weight:700}
.btn-ghost{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:6px 10px;border-radius:8px}
@media(max-width:980px){.container{grid-template-columns:1fr}aside.card{max-height:none}}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash" class="splash">
  <img src="BETL.png" alt="BETL" class="splash-logo" onerror="this.style.display='none'">
  <div style="color:var(--muted);margin-top:6px">Chargement… <span id="splashPct">0%</span></div>
</div>

<!-- HEADER -->
<header>
  <img src="BETL.png" alt="BETL" class="logo" onclick="window.open('https://www.facebook.com/BETL120','_blank')" onerror="this.style.display='none'">
  <div class="titleWrap">
    <div class="title">BETL — Visualisation 3D & Plans</div>
    <div class="subtitle">Voir ta maison avant de l'habiter</div>
  </div>

  <div class="hdr-controls" id="hdrControls"></div>
</header>

<!-- CONTENT -->
<div class="container">
  <main class="card">
    <div style="display:flex;justify-content:space-between;margin-bottom:6px">
      <div style="font-weight:700">Aperçu 3D</div>
      <div style="color:var(--muted);font-size:12px">2 modèle(s)</div>
    </div>

    <div style="text-align:center">
      <model-viewer id="viewer" src="models/Djanet_arch.glb" ar ar-modes="scene-viewer webxr" camera-controls exposure="1">
          <button slot="ar-button" class="ar-button">Voir en Réalité Augmentée</button>
        </model-viewer>
    </div>

    <div id="progressWrap" class="progress-wrap" style="">
      <div class="progress"><span id="progressBar"></span></div>
      <div class="progress-label" id="progressLabel">0%</div>
    </div>

    <div id="statusMsg" style="margin-top:8px;color:var(--muted);font-size:13px"></div>
  </main>

  <aside class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
      <div style="font-weight:700">Plans & Documents</div>
      <div style="font-size:12px;color:var(--muted)">3 fichier(s)</div>
    </div>

    <!-- NEW modern Plans & Documents block (search left under title) -->
    <div class="plans-docs" id="plansDocsRoot">
      <header class="pd-header">
        <h3>Plans & Documents</h3>
        <div class="pd-controls" aria-hidden="false">
          <div id="pd-categories" class="pd-categories"></div>
        </div>
      </header>

      <!-- row: search (left) + categories (right) -->
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;margin-bottom:10px">
        <div style="flex:1;max-width:60%;">
          <input id="pd-search" class="pd-search" placeholder="Rechercher un document..." aria-label="Recherche documents">
        </div>
        <div style="flex:1;display:flex;justify-content:flex-end;">
          <div id="pd-categories-right" class="pd-categories" aria-hidden="false"></div>
        </div>
      </div>

      <main id="pd-grid" class="pd-grid">
      </main>
    </div>

  </aside>
</div>

<!-- PREVIEW modal -->
<div id="previewModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div id="previewTitle"></div>
      <button class="pill" onclick="closePreview()">Fermer</button>
    </div>
    <div class="modal-body">
      <iframe id="previewIframe" class="preview-iframe" src=""></iframe>
    </div>
  </div>
</div>

<script>
  const MODELS = ["Djanet_arch.glb","Djanet_gc.glb"];
  const PDFS = {"Architecture":["bentelha permis -modi02 mise en page-Model.pdf"],"GC":["permis (1)-Model.pdf"],"Autre":["BETL.png"]};

  function encodePath(s){ return encodeURIComponent(s).replace(/%2F/g,'/'); }

  /* --- header selector (placeholder "Choisir modèle 3D") --- */
  (function initHeaderSelector(){
    const hdr = document.getElementById('hdrControls');
    if(!hdr) return;
    if(!MODELS || MODELS.length === 0) return;

    const sel = document.createElement('select');
    sel.className = 'model-select';
    sel.id = 'modelSelect';

    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = 'Choisir modèle 3D';
    opt0.selected = true;
    opt0.disabled = false;
    sel.appendChild(opt0);

    const archs = MODELS.filter(m=>/arch|architect/i.test(m));
    const gcs = MODELS.filter(m=>/gc|genie|civil/i.test(m));

    if(archs.length){
      archs.forEach(m=>{ const o=document.createElement('option'); o.value='models/'+encodePath(m); o.textContent='Architecture — '+m; sel.appendChild(o); });
    }
    if(gcs.length){
      gcs.forEach(m=>{ const o=document.createElement('option'); o.value='models/'+encodePath(m); o.textContent='Génie Civil — '+m; sel.appendChild(o); });
    }
    MODELS.forEach(m=>{
      if(archs.includes(m) || gcs.includes(m)) return;
      const o=document.createElement('option'); o.value='models/'+encodePath(m); o.textContent=m; sel.appendChild(o);
    });

    sel.addEventListener('change', ()=> {
      const val = sel.value;
      const v = document.getElementById('viewer');
      if(v && val) v.src = val;
    });

    hdr.appendChild(sel);
  })();

  /* ---------------- build initial documents list for new UI ---------------- */
  (function buildInitialDocsAndInit(){
    const docs = [];
    // PDFS is injected from server-side variable
    for (const catKey of Object.keys(PDFS || {})) {
      const prettyCat = (catKey === 'GC') ? 'Génie Civil' : catKey;
      const files = PDFS[catKey] || [];
      for (const f of files) {
        docs.push({
          title: f,
          category: prettyCat,
          file: 'pdfs/' + encodePath(catKey) + '/' + encodePath(f),
          thumb: null
        });
      }
    }
    // call the UI init (defined below)
    window.INITIAL_DOCS = docs;
  })();

  /* New Plans & Documents UI code (search on left under title) */
  (function () {
    const documents = window.INITIAL_DOCS || [];
    const pdGrid = document.getElementById('pd-grid');
    const pdCatsLeft = document.getElementById('pd-categories');
    const pdCatsRight = document.getElementById('pd-categories-right');
    const pdSearch = document.getElementById('pd-search');

    function getCategories(docs){
      const order = ["Architecture","Génie Civil","Autre"];
      const cats = [...new Set(docs.map(d=>d.category || "Autre"))];
      return order.filter(o=>cats.includes(o)).concat(cats.filter(c=>!order.includes(c)));
    }

    let activeCategory = null;
    let filteredDocs = documents.slice();

    function renderCategories(){
      const cats = getCategories(documents);
      // clear both containers
      if(pdCatsLeft) pdCatsLeft.innerHTML = '';
      if(pdCatsRight) pdCatsRight.innerHTML = '';
      if(!cats || cats.length===0) return;

      const makeBtn = (text) => {
        const b = document.createElement('button');
        b.className = 'pd-category-btn';
        b.textContent = text;
        b.onclick = ()=> { activeCategory = (text === 'Tous' ? null : text); setActiveCat(); renderGrid(); };
        return b;
      };

      // Tous button
      const allLeft = makeBtn('Tous');
      allLeft.classList.add('active');
      if(pdCatsLeft) pdCatsLeft.appendChild(allLeft);
      if(pdCatsRight) pdCatsRight.appendChild(allLeft.cloneNode(true));

      cats.forEach(c=>{
        const bL = makeBtn(c);
        if(pdCatsLeft) pdCatsLeft.appendChild(bL);
        const bR = makeBtn(c);
        if(pdCatsRight) pdCatsRight.appendChild(bR);
      });

      // After rendering, ensure active state matches current activeCategory
      setActiveCat();
    }

    function setActiveCat(){
      const allBtns = document.querySelectorAll('.pd-category-btn');
      allBtns.forEach(b=>{
        const text = b.textContent;
        b.classList.toggle('active', (activeCategory === null && text === 'Tous') || (text === activeCategory));
      });
    }

    function renderGrid(){
      const q = pdSearch ? pdSearch.value.trim().toLowerCase() : '';
      filteredDocs = documents.filter(function(d){
        if(activeCategory && d.category !== activeCategory) return false;
        if(q && !((d.title||'').toLowerCase().includes(q) || (d.category||'').toLowerCase().includes(q))) return false;
        return true;
      });
      pdGrid.innerHTML = '';
      if(filteredDocs.length === 0){
        pdGrid.innerHTML = '<div style="padding:12px;text-align:center;color:var(--muted)">Aucun document trouvé.</div>';
        return;
      }
      filteredDocs.forEach(function(doc){
        const card = document.createElement('article');
        card.className = 'pd-card';
        const left = document.createElement('div');
        left.style.flex = '1';
        left.innerHTML = '<div class="pd-title">' + escapeHtml(doc.title) + '</div>' +
                         '<div class="pd-meta">' + escapeHtml(doc.category) + '</div>';
        const actions = document.createElement('div');
        actions.style.display='flex'; actions.style.gap='8px';
        const btnView = document.createElement('button');
        btnView.className='btn';
        btnView.textContent='Voir';
        btnView.onclick = ()=> openPreview(doc.title, doc.file);
        const btnDetails = document.createElement('button');
        btnDetails.className='btn-ghost';
        btnDetails.textContent='Détails';
        btnDetails.onclick = ()=> alert('Détails: ' + doc.title);
        actions.appendChild(btnView);
        actions.appendChild(btnDetails);
        card.appendChild(left);
        card.appendChild(actions);
        pdGrid.appendChild(card);
      });
    }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;', "'":'&#39;' }[c])); }

    // preview modal controls
    function openPreview(title,path){
      const tEl = document.getElementById('previewTitle');
      const ifr = document.getElementById('previewIframe');
      if(tEl) tEl.textContent = title;
      if(ifr) ifr.src = path;
      const modal = document.getElementById('previewModal');
      if(modal) modal.style.display = 'flex';
    }
    function closePreview(){ const ifr = document.getElementById('previewIframe'); if(ifr) ifr.src = ''; const modal = document.getElementById('previewModal'); if(modal) modal.style.display = 'none'; }

    // attach globals
    window.openPreview = openPreview;
    window.closePreview = closePreview;

    // events
    if(pdSearch) pdSearch.addEventListener('input', ()=> renderGrid());

    // init
    renderCategories();
    renderGrid();
  })();

  /* viewer progress + loader */
  document.addEventListener('DOMContentLoaded', ()=> {
    const viewer = document.getElementById('viewer');
    if(viewer){
      const pbar = document.getElementById('progressBar');
      const plabel = document.getElementById('progressLabel');
      const splash = document.getElementById('splash');
      const progressWrap = document.getElementById('progressWrap');

      viewer.addEventListener('progress', (e)=> {
        const pct = Math.floor((e.detail.totalProgress||0)*100);
        if(pbar) pbar.style.width = pct + '%';
        if(plabel) plabel.textContent = pct + '%';
        if(document.getElementById('splashPct')) document.getElementById('splashPct').textContent = pct + '%';
        if(pct >= 100){
          if(splash) setTimeout(()=>{ splash.classList.add('hidden'); }, 350);
          if(progressWrap) setTimeout(()=>{ progressWrap.style.opacity = '0'; progressWrap.style.pointerEvents = 'none'; setTimeout(()=>progressWrap.style.display='none',300); }, 600);
          if(plabel) plabel.textContent = '100%';
        }
      });
    }
  });

  /* simple preview close helper for top-level modal */
  function closePreview(){ var ifr = document.getElementById('previewIframe'); if(ifr) ifr.src=''; var modal = document.getElementById('previewModal'); if(modal) modal.style.display='none'; }
  window.closePreview = closePreview;
</script>

</body>
</html>
