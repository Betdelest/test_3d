<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Projet BETL</title>
<script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
<style>
  :root{--bg:#0b0f14;--card:#0f1720;--muted:#9aa6b2;--accent:#0a84ff;--glass:rgba(255,255,255,0.06)}
  html,body{height:100%;margin:0;background:var(--bg);color:#fff;font-family:Inter,Arial,Helvetica,sans-serif}
  /* header compact */
  header{display:flex;align-items:center;gap:10px;padding:8px 12px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent);box-shadow:0 6px 18px rgba(0,0,0,0.35)}
  .logo{height:44px;width:44px;object-fit:contain;border-radius:6px;cursor:pointer}
  .title{font-weight:700;font-size:15px;line-height:1}
  .subtitle{font-size:11px;color:var(--muted)}
  .top-controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  .pill{background:var(--glass);border-radius:10px;padding:7px 10px;border:0;color:#fff;cursor:pointer;font-size:13px}
  .pill.primary{background:var(--accent);color:#000;font-weight:600}
  .small{padding:6px 8px;font-size:12px;border-radius:8px}
  .mini{padding:6px 8px;font-size:12px;border-radius:8px}
  .container{padding:12px;display:grid;grid-template-columns:1fr 320px;gap:12px}
  main.card{background:linear-gradient(180deg, rgba(255,255,255,0.02), transparent);border-radius:10px;padding:10px;min-height:60vh}
  aside.card{background:var(--card);border-radius:10px;padding:12px;max-height:78vh;overflow:auto}
  model-viewer{width:100%;height:58vh;border-radius:10px;background:#111}
  .progress-wrap{display:flex;align-items:center;gap:10px;margin-top:10px;transition:opacity .25s}
  .progress{flex:1;height:10px;background:#111;border-radius:999px;overflow:hidden}
  .progress > span{display:block;height:100%;width:0;background:linear-gradient(90deg,var(--accent),#4bd3ff);transition:width .2s}
  .progress-label{min-width:44px;text-align:right;color:var(--muted);font-size:13px}
  .plan-item{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;background:#0b1116;margin-bottom:8px}
  .plan-item .name{max-width:66%;font-size:14px;word-break:break-word;color:#e6eef8}
  .plan-actions{display:flex;gap:8px}
  .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:1200}
  .modal{width:min(1000px,96%);height:min(84vh,900px);background:#08101a;border-radius:10px;overflow:hidden;display:flex;flex-direction:column}
  .modal-header{padding:10px;background:#07101a;display:flex;justify-content:space-between;align-items:center}
  .modal-body{flex:1;background:#fff}
  .preview-iframe{width:100%;height:100%;border:0}
  .splash{position:fixed;inset:0;background:#000;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:2000}
  .splash.hidden{opacity:0;pointer-events:none;display:none;transition:opacity .35s}
  .splash-logo{width:180px;max-width:50vw;margin-bottom:8px;filter:drop-shadow(0 8px 30px rgba(0,0,0,0.6))}
  @media(max-width:980px){.container{grid-template-columns:1fr;padding:10px}aside.card{order:2}main.card{order:1}model-viewer{height:46vh}}
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash" class="splash">
  <img src="BETL.png" alt="BETL" class="splash-logo" onerror="this.style.display='none'">
  <div style="color:var(--muted);margin-top:6px">Chargement… <span id="splashPct">0%</span></div>
</div>

<!-- HEADER -->
<header>
  <img src="BETL.png" alt="BETL" class="logo" onclick="window.open('https://www.facebook.com/BETL120','_blank')" onerror="this.style.display='none'">
  <div>
    <div class="title">BETL — Visualisation 3D & Plans</div>
    <div class="subtitle">Voir ta maison avant de l'habiter</div>
  </div>

  <div class="top-controls">
    <button class="pill small" onclick="openPlans()">Plans</button>
    <button class="pill primary mini" id="arLaunch">Voir en AR</button>
    <button class="pill mini" id="btnModelArch" onclick="selectModelCategory('Architecture')">Modèle Arch</button>
    <button class="pill mini" id="btnModelGC" onclick="selectModelCategory('GC')">Modèle GC</button>
  </div>
</header>

<!-- CONTENT -->
<div class="container">
  <main class="card">
    <div style="display:flex;justify-content:space-between;margin-bottom:6px">
      <div style="font-weight:700">Aperçu 3D</div>
      <div style="color:var(--muted);font-size:12px">2 modèle(s)</div>
    </div>

    <div>
      <model-viewer id="viewer" src="models/Djanet_arch.glb" ar ar-modes="scene-viewer webxr" camera-controls exposure="1"></model-viewer>
    </div>

    <div id="progressWrap" class="progress-wrap" style="">
      <div class="progress"><span id="progressBar"></span></div>
      <div class="progress-label" id="progressLabel">0%</div>
    </div>

    <div id="statusMsg" style="margin-top:8px;color:var(--muted);font-size:13px"></div>
  </main>

  <aside class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:700">Plans & Documents</div>
      <div style="font-size:12px;color:var(--muted)">3 fichier(s)</div>
    </div>

    <div style="display:flex;gap:6px;margin-bottom:10px">
      <button class="pill" id="tabArch">Architecture</button>
      <button class="pill" id="tabGC">Génie Civil</button>
      <button class="pill" id="tabOther">Autre</button>
    </div>

    <div id="plansList"></div>
  </aside>
</div>

<!-- PREVIEW -->
<div id="previewModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <div id="previewTitle"></div>
      <button class="pill" onclick="closePreview()">Fermer</button>
    </div>
    <div class="modal-body">
      <iframe id="previewIframe" class="preview-iframe" src=""></iframe>
    </div>
  </div>
</div>

<script>
  const MODELS = ["Djanet_arch.glb","Djanet_gc.glb"];
  const PDFS = {"Architecture":["bentelha permis -modi02 mise en page-Model.pdf"],"GC":["permis (1)-Model.pdf"],"Autre":["BETL.png"]};

  function encodePath(s){return encodeURIComponent(s).replace(/%2F/g,'/');}

  /* Render plans list */
  function renderPlans(cat){
    const list = document.getElementById('plansList');
    list.innerHTML = '';
    const files = PDFS[cat] || [];
    if(!files.length){ list.innerHTML = '<div style="color:var(--muted)">Aucun document</div>'; return; }
    files.forEach(f=>{
      const row = document.createElement('div');
      row.className = 'plan-item';
      const href = 'pdfs/' + encodePath(cat) + '/' + encodePath(f);
      row.innerHTML = `
        <div class="name">${f}</div>
        <div class="plan-actions">
          <a class="pill" href="${href}" target="_blank">Voir</a>
          <button class="pill" onclick="downloadFile('${encodePath(cat)+'/'+encodePath(f)}')">Télécharger</button>
        </div>
      `;
      list.appendChild(row);
    });
  }

  /* choose model by category (buttons) */
  function selectModelCategory(cat){
    if(!MODELS || !MODELS.length) return;
    let sel = '';
    for(const m of MODELS){
      const low = m.toLowerCase();
      if(cat==='GC' && low.includes('gc')) { sel = 'models/'+m; break; }
      if(cat==='Architecture' && (low.includes('arch')||low.includes('architect'))) { sel = 'models/'+m; break; }
    }
    if(!sel && MODELS.length) sel = 'models/'+MODELS[0];
    const v = document.getElementById('viewer');
    if(v && sel) v.src = sel;
  }

  document.addEventListener('DOMContentLoaded', ()=> {
    if(document.getElementById('tabArch')) document.getElementById('tabArch').onclick = ()=>renderPlans('Architecture');
    if(document.getElementById('tabGC')) document.getElementById('tabGC').onclick = ()=>renderPlans('GC');
    if(document.getElementById('tabOther')) document.getElementById('tabOther').onclick = ()=>renderPlans('Autre');

    if(true) renderPlans('Architecture'); else if(true) renderPlans('GC'); else if(true) renderPlans('Autre');

    const viewer = document.getElementById('viewer');
    if(viewer){
      const pbar = document.getElementById('progressBar');
      const plabel = document.getElementById('progressLabel');
      const splash = document.getElementById('splash');
      const progressWrap = document.getElementById('progressWrap');

      viewer.addEventListener('progress', (e)=> {
        const pct = Math.floor((e.detail.totalProgress||0)*100);
        if(pbar) pbar.style.width = pct + '%';
        if(plabel) plabel.textContent = pct + '%';
        if(document.getElementById('splashPct')) document.getElementById('splashPct').textContent = pct + '%';
        // when complete: hide splash and hide progress bar after short delay
        if(pct >= 100){
          if(splash) setTimeout(()=>{ splash.classList.add('hidden'); }, 350);
          if(progressWrap) setTimeout(()=>{ progressWrap.style.opacity = '0'; progressWrap.style.pointerEvents = 'none'; setTimeout(()=>progressWrap.style.display='none',300); }, 600);
          if(plabel) plabel.textContent = '100%';
        }
      });
    }

    /* AR launch button */
    const ar = document.getElementById('arLaunch');
    if(ar && document.getElementById('viewer')){
      ar.onclick = async ()=> {
        try{ await document.getElementById('viewer').enterAR(); }
        catch(e){ alert("RA non supportée — ouvre avec Chrome Android."); }
      };
    }

    /* model quick-select buttons: hide if no matching model */
    if(!(true)){
      const b1 = document.getElementById('btnModelArch'); if(b1) b1.style.display='none';
      const b2 = document.getElementById('btnModelGC'); if(b2) b2.style.display='none';
    } else {
      // if there is no arch-like model, grey the button
      const anyArch = MODELS.some(m => m.toLowerCase().includes('arch')||m.toLowerCase().includes('architect'));
      const anyGc = MODELS.some(m => m.toLowerCase().includes('gc')||m.toLowerCase().includes('gc'));
      const b1 = document.getElementById('btnModelArch'); if(b1 && !anyArch) b1.style.opacity = '0.5';
      const b2 = document.getElementById('btnModelGC'); if(b2 && !anyGc) b2.style.opacity = '0.5';
    }

  });

  function openPreview(title, path){
    document.getElementById('previewTitle').textContent = title;
    document.getElementById('previewIframe').src = path;
    document.getElementById('previewModal').style.display = 'flex';
  }
  function closePreview(){ document.getElementById('previewIframe').src=''; document.getElementById('previewModal').style.display='none'; }

  function downloadFile(relPath){
    const url = relPath;
    fetch(url).then(r=>r.blob()).then(blob=>{
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = decodeURIComponent(relPath.split('/').pop());
      document.body.appendChild(a); a.click(); a.remove();
      URL.revokeObjectURL(a.href);
    }).catch(()=>window.open(url,'_blank'));
  }

</script>
</body>
</html>